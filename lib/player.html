<!DOCTYPE html><html lang="en"><head><title>lib/player</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/player"><meta name="groc-project-path" content="lib/player.coffee"><meta name="groc-github-url" content="https://github.com/Yoshiyuka/meteor-mud"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/Yoshiyuka/meteor-mud/blob/master/lib/player.coffee">lib/player.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="player">Player</h1>

<hr />

<p><strong>(extends the Creature class)</strong> <br />
Only one Player instance will exist per session for each client. Fields are populated based on data from the Characters collection in the mongo database.  </p></div></div><div class="code"><div class="wrapper"><span class="c1">#Because it is stored in the /lib folder, the Player class is available to both server and client code.</span>
<span class="k">class</span> <span class="nx">Player</span> <span class="k">extends</span> <span class="nx">share</span><span class="p">.</span><span class="nx">Creature</span>
    <span class="c1">#region Player Constructor</span>
    <span class="nv">constructor: </span><span class="p">()</span> <span class="nf">-&gt;</span>
        <span class="k">super</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="client-only-code">Client-Only Code:</h3>

<p>Only run the following code if the file is loaded client-side. Server will ignore this.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">isClient</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Player constructor has been called. Attempting to subscribe to relevant collections...&quot;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">@currentRoom</span>

            <span class="vi">@Inventory = </span><span class="k">new</span> <span class="nx">share</span><span class="p">.</span><span class="nx">Inventory</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="vi">@Equipment = </span><span class="k">new</span> <span class="nx">share</span><span class="p">.</span><span class="nx">Equipment</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

            <span class="nx">@Inventory</span><span class="p">.</span><span class="nx">addItem</span><span class="p">({</span><span class="nv">_id: </span><span class="mi">999</span><span class="p">,</span> <span class="nv">text: </span><span class="s">&quot;test object&quot;</span><span class="p">},</span> <span class="mi">4</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">@Inventory</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">@Equipment</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span>
            <span class="nx">@Equipment</span><span class="p">.</span><span class="nx">equip</span><span class="p">({</span><span class="nv">name: </span><span class="s">&quot;test item&quot;</span><span class="p">,</span> <span class="nv">slot: </span><span class="s">&quot;left_earring&quot;</span><span class="p">},</span> <span class="s">&quot;left_earring&quot;</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">@Equipment</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span>
            <span class="nx">@Equipment</span><span class="p">.</span><span class="nx">equip</span><span class="p">({</span><span class="nv">name: </span><span class="s">&quot;other test item&quot;</span><span class="p">},</span> <span class="s">&quot;helm&quot;</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">@Equipment</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span>
            </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><em>The instantiation of the Player class indicates that the client is signed in and has selected a character to play with. This means it's safe to subscribe to the world-related collections...</em></p></div></div><div class="code"><div class="wrapper">            </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Subscribe to the Regions collection. When the collection is ready, look up the current region the Player is in based on its current room and then subscribe to the Rooms collection.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&quot;regions&quot;</span><span class="p">,</span> <span class="nx">@currentRoom</span><span class="p">,</span> <span class="p">{</span>
                <span class="nv">onReady: </span><span class="p">()</span> <span class="o">=&gt;</span>
                    <span class="nv">region = </span><span class="nx">Regions</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">rooms: </span><span class="p">{</span><span class="nv">$in: </span><span class="p">[</span><span class="nx">@currentRoom</span><span class="p">]}})</span>
                    
                    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&quot;rooms&quot;</span><span class="p">,</span> <span class="nx">region</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nv">onError: </span><span class="nf">(err) -&gt;</span> 
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">err</span><span class="p">.</span><span class="nx">error</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">reason</span>
                        <span class="nv">onReady: </span><span class="p">()</span> <span class="nf">-&gt;</span>
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;subscribing to rooms for &quot;</span> <span class="o">+</span> <span class="nx">region</span><span class="p">.</span><span class="nx">name</span>
                    <span class="p">})</span>
            <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Subscribe to the Messages collection. sessionStart returns client's time to filter out old messages we weren't connected to the server to see.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="nx">@currentRoom</span><span class="p">,</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;sessionStart&quot;</span><span class="p">),</span> <span class="p">{</span>
                <span class="nv">onError: </span><span class="nf">(err) -&gt;</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;it seems we have an error in Player.constructor&quot;</span>
                <span class="nv">onReady: </span><span class="p">()</span> <span class="o">=&gt;</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;subscribing to messages for &quot;</span> <span class="o">+</span> <span class="nx">@currentRoom</span>
            <span class="p">})</span>

            </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Begin observing the user document matching the client's id. Any changes to the user document will trigger an appropriate observer event.</p></div></div><div class="code"><div class="wrapper">            <span class="nv">selectedCursor = </span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">()})</span>
            <span class="nv">playerCursor = </span><span class="kc">undefined</span>
            <span class="vi">@selectedObserver = </span><span class="nx">selectedCursor</span><span class="p">.</span><span class="nx">observeChanges</span><span class="p">(</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>When the user document is first found, this will be triggered. An observer will be created to watch the character matching the selected character id. Any changes to the watched character data in the database will cause the client's Player class instance to be repopulated with the new document data.</p></div></div><div class="code"><div class="wrapper">                <span class="nv">added: </span><span class="nf">(id, fields) =&gt;</span>
                    <span class="k">if</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">profile</span> <span class="o">isnt</span> <span class="kc">undefined</span> <span class="o">and</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">selected</span> <span class="o">isnt</span> <span class="kc">undefined</span>
                        <span class="nv">character = </span><span class="nx">Characters</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">fields</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">selected</span><span class="p">})</span>
                        <span class="nx">@_populateData</span><span class="p">(</span><span class="nx">character</span><span class="p">)</span>

                        <span class="nv">playerCursor = </span><span class="nx">Characters</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">@_id</span><span class="p">,</span> <span class="nv">owner: </span><span class="nx">@owner</span><span class="p">})</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">@_id</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">@owner</span>
                        <span class="vi">@playerObserver = </span><span class="nx">playerCursor</span><span class="p">.</span><span class="nx">observeChanges</span><span class="p">(</span>
                            <span class="nv">added: </span><span class="nf">(id, fields) =&gt;</span>
                                <span class="nx">@_populateData</span><span class="p">(</span><span class="nx">fields</span><span class="p">)</span>
                            <span class="nv">changed: </span><span class="nf">(id, fields) =&gt;</span>
                                <span class="nx">@_populateData</span><span class="p">(</span><span class="nx">fields</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;fields.profile or fields.profile.selected is undefined in added callback for @selectedObserver&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="todocheck-for-existance-of-the-observer-first-at-beginning-of-event-and-stop-it-before-starting-a-new-one-this-is-a-memory-leak-that-needs-to-be-addressed">TODO:CHECK FOR EXISTANCE OF THE OBSERVER FIRST AT BEGINNING OF EVENT AND STOP IT BEFORE STARTING A NEW ONE! THIS IS A MEMORY LEAK THAT NEEDS TO BE ADDRESSED!!!</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>When the profile.selected field in the user document is altered, this 'changed' event will be triggered. This gets the data for the character matching the id in the profile.selected field and then creates an observer to watch the new character document. Any changes to that document will trigger a repopulation of this Player class instance's data. </p></div></div><div class="code"><div class="wrapper">                <span class="nv">changed: </span><span class="nf">(id, fields) =&gt;</span>
                    <span class="k">if</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">profile</span> <span class="o">isnt</span> <span class="kc">undefined</span> <span class="o">and</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">selected</span> <span class="o">isnt</span> <span class="kc">undefined</span>
                        <span class="nv">character = </span><span class="nx">Characters</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">fields</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">selected</span><span class="p">})</span>
                        <span class="nx">@_populateData</span><span class="p">(</span><span class="nx">character</span><span class="p">)</span>

                        <span class="k">if</span> <span class="nx">@playerObserver</span><span class="o">?</span>
                            <span class="nx">@playerObserver</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
                            <span class="nv">playerCursor = </span><span class="nx">Characters</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">@_id</span><span class="p">,</span> <span class="nv">owner: </span><span class="nx">@owner</span><span class="p">})</span>
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">@_id</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">@owner</span>
                            <span class="vi">@playerObserver = </span><span class="nx">playerCursor</span><span class="p">.</span><span class="nx">observeChanges</span><span class="p">(</span>
                                <span class="nv">added: </span><span class="nf">(id, fields) =&gt;</span>
                                    <span class="nx">@_populateData</span><span class="p">(</span><span class="nx">fields</span><span class="p">)</span>
                                <span class="nv">changed: </span><span class="nf">(id, fields) =&gt;</span>
                                    <span class="nx">@_populateData</span><span class="p">(</span><span class="nx">fields</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">else</span>
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;playerObserver is invalid&quot;</span>
                    <span class="k">else</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;fields.profile or fields.profile.selected is undefined in changed callback for @selectedObserver&quot;</span>
            <span class="p">)</span>
    <span class="c1">#endregion</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><strong>_populateData(Object)</strong> - Helper function which adds/sets the fields of the Player class instance of those provided by 'data'</p></div></div><div class="code"><div class="wrapper">    <span class="nv">_populateData: </span><span class="nf">(data) =&gt;</span>
        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">data</span>
            <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

<span class="c1">#region Movement Code</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><strong>moveTo(String)</strong> - 
Checks to make sure that the player is both in a valid room (should always be true) and that the direction the player wants to go towards exists in the current room (rooms must be attached). </p></div></div><div class="code"><div class="wrapper">    <span class="nv">moveTo: </span><span class="nf">(direction) -&gt;</span>
        <span class="nx">check</span><span class="p">(</span><span class="nx">direction</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">@currentRoom</span> <span class="o">is</span> <span class="kc">undefined</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;current room is undefined, somehow.... no valid moves from this location.&quot;</span>
            <span class="k">return</span>

        <span class="nv">room = </span><span class="nx">Rooms</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">name: </span><span class="nx">@currentRoom</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">room</span><span class="o">?</span> <span class="o">and</span> <span class="nx">room</span><span class="p">[</span><span class="nx">direction</span><span class="p">]</span><span class="o">?</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">direction</span> <span class="o">+</span> <span class="s">&quot; appears to be a valid move. Attempting move...&quot;</span>
            <span class="nv">time = </span><span class="kc">undefined</span>
            </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><strong>Send an asynchronous call to the server code so that the server can validate intentions and perform the database updates. We absolutely do not allow clients to modify the database directly.</strong></p></div></div><div class="code"><div class="wrapper">            <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s">&quot;validateAndMove&quot;</span><span class="p">,</span> <span class="nx">@currentRoom</span><span class="p">,</span> <span class="nx">room</span><span class="p">[</span><span class="nx">direction</span><span class="p">],</span> <span class="nf">(error, result) -&gt;</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">error</span><span class="p">.</span><span class="nx">err</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">reason</span>
                <span class="k">else</span>
                    <span class="nv">time = </span><span class="nx">result</span>
            <span class="p">)</span>

            <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&quot;sessionStart&quot;</span><span class="p">,</span> <span class="nx">time</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="nx">LocalMessages</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nv">text: </span><span class="s">&quot;That appears to be a dead end.&quot;</span><span class="p">})</span>
<span class="c1">#endregion</span>

    <span class="nv">tick: </span><span class="p">()</span> <span class="o">=&gt;</span>
        <span class="k">super</span>

    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><strong>Make the Player class available to all CoffeeScript files.</strong></p></div></div><div class="code"><div class="wrapper"><span class="nv">share.Player = </span><span class="nx">Player</span></div></div></div></div></body></html>